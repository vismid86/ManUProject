dist: trusty
sudo: required
services:
- docker
  #branches:
  #only:
  #- travis-ci
cache:
  ccache: true
  pip: true
  directories:
    - dpdk
    - node_modules
language:
- c
- python

#Move to jobs
#env:
#  global:
#    - DEBIAN_FRONTEND=noninteractive
#    - GCC_PATH=/opt/gcc-arm/bin:$PATH
#    - DOCKER_CONTAINER_NAME=travis-cont
#    - DOCKER_BUILD_NAME=travis:16.04
#    - DOCKER_COMMIT_IMAGE=myriota-travis:16.04
#    - DOCKER_REPO=finalbuild

# Build docker image, Run container, Install packages, Push it to repository
before_install:
- |
        ##### TEST TYPE####
         if [ "$TRAVIS_EVENT_TYPE" == "cron" ]; then export TEST_TYPE=nightly-test; fi
         if [ "$TRAVIS_EVENT_TYPE" == "pull_request" ]; then export TEST_TYPE=test; fi
         if [ "$TRAVIS_EVENT_TYPE" == "push" ]; then export TEST_TYPE=pushtest; fi
         echo $TEST_TYPE
- chmod +x install-apt.sh
- tr -d '\r' < install-apt.sh > install-apt-r.sh
- chmod +x install-apt-r.sh
- chmod +x install-test.sh
- docker --version
# New changes
- docker build -f ${DOCKER_PATH}/Dockerfile --tag "${DOCKER_BUILD_NAME}:${DOCKER_TAG}" .
- docker run --name "${DOCKER_CONTAINER_NAME}" -dit -v `pwd`:${DOCKER_WORK_DIR} "${DOCKER_BUILD_NAME}:${DOCKER_TAG}"
- docker exec "${DOCKER_CONTAINER_NAME}" /bin/sh -c './install-apt-r.sh'
- docker exec "${DOCKER_CONTAINER_NAME}" /bin/sh -c 'PATH=/opt/gcc-arm/bin:$PATH; ./install-test.sh; echo $PATH;'
- docker commit "${DOCKER_CONTAINER_NAME}"  "${DOCKER_COMMIT_IMAGE}:${DOCKER_TAG}"
- docker images
- docker tag "${DOCKER_COMMIT_IMAGE}:${DOCKER_TAG}" "$DOCKERUSER/${DOCKER_REPO}"
 # Login to DockerHub and Push the image
- echo $DOCKERPASS1 | docker login -u $DOCKERUSER1 --password-stdin
- docker push $DOCKERUSER/${DOCKER_REPO}

#Script for test stage
script:
- echo "Test stage for ${DOCKER_REPO} is Started"
- docker run --name ${DOCKER_TEST_CONTAINER} -dit -v `pwd`:${DOCKER_WORK_DIR} ${DOCKERUSER}/${DOCKER_REPO}:latest
- docker exec ${DOCKER_TEST_CONTAINER} /bin/sh -c 'pwd; ls -lrt; echo $PATH; PATH=/opt/gcc-arm/bin:$PATH; ./install-test.sh; echo $PATH'
- docker exec ${DOCKER_TEST_CONTAINER} bash -c 'echo "Finished successfully"'

#Clean up Containers and image after run
after_script :
- |
        #####TEST LOG FILES########
        echo "Testlog"
        if [ "$TRAVIS_EVENT_TYPE" == "cron" ]; then echo "you are in cron"; fi
- |
        ###Docker cleanup####
        docker ps -aq; docker stop $(docker ps -aq); docker rm $(docker ps -aq); docker rmi $(docker images -q)

jobs:
# Run if only the branch is travis-ci
  if: branch = travis-ci
  include:
# Build stage for installing packages in 16.04 ubuntu image. Uses before_install and push the finalimage
    - stage: build
      name: "Build Ubuntu16.04"
      if: type = push AND commit_message=build
      env:
        - DOCKER_PATH=ubuntu16.04
        - DOCKER_BUILD_NAME=travis
        - DOCKER_CONTAINER_NAME=travis-cont-xenial
        - DOCKER_COMMIT_IMAGE=myriota-travis
        - DOCKER_TAG=16.04
        - DOCKER_REPO=travis-xenial
        - DOCKER_WORK_DIR=/CI-test-xenial
      # Just a test to go to script stage with condition to execute only for push commits
      script:
        - echo "Build stage for 16.04 is Complete and Container is ${DOCKER_CONTAINER_NAME}"
      # Calls after script Cleans containers and image.
# Build stage for installing packages in 18.04 ubuntu image. Uses before_install and push the finalimage
    - stage: build
      name: "Build Ubuntu18.04"
      if: type = push AND commit_message=build
      env:
        - DOCKER_PATH=ubuntu18.04
        - DOCKER_BUILD_NAME=travis
        - DOCKER_CONTAINER_NAME=travis-cont-bionic
        - DOCKER_COMMIT_IMAGE=myriota-travis
        - DOCKER_TAG=18.04
        - DOCKER_REPO=travis-bionic
        - DOCKER_WORK_DIR=/CI-test-bionic
      # Just a test to go to script stage with condition to execute only for push commits.
      script:
        - echo "Build stage for 18.04 is Complete and Container is ${DOCKER_CONTAINER_NAME}"
      # Calls after script Cleans containers and image.
# Test stage to pull the image from repo. Execute tests.
    - stage: test
      name: "Test on Ubuntu16.04"
      env:
        - DOCKER_REPO=travis-xenial
        - DOCKER_WORK_DIR=/CI-test-xenial
        - DOCKER_TEST_CONTAINER=testcontainer-xenial
        - PATH=/opt/gcc-arm/bin:$PATH
      before_install:
        - |
          ##### TEST TYPE####
           if [ "$TRAVIS_EVENT_TYPE" == "cron" ]; then export TEST_TYPE=nightly-test; fi
           if [ "$TRAVIS_EVENT_TYPE" == "pull_request" ]; then export TEST_TYPE=test; fi
           if [ "$TRAVIS_EVENT_TYPE" == "push" ]; then export TEST_TYPE=pushtest; fi
           echo $TEST_TYPE
        - echo $DOCKERPASS1 | docker login -u $DOCKERUSER1 --password-stdin
        - docker pull $DOCKERUSER1/${DOCKER_REPO}:latest
      # Calls script stage defined above for tests.
      # Calls after script Cleans containers and image.
# Test stage to pull the image from repo. Execute tests.
    - stage: test
      NAME: "Test on Ubuntu18.04"
      env:
        - DOCKER_REPO=travis-bionic
        - DOCKER_WORK_DIR=/CI-test-bionic
        - DOCKER_TEST_CONTAINER=testcontainer-bionic
        - PATH=/opt/gcc-arm/bin:$PATH
      before_install:
        - docker pull $DOCKERUSER/${DOCKER_REPO}:latest
      # Calls script stage defined above for tests.
      # Calls after script Cleans containers and image.


# Working Matrix Starts
#matrix:
#  fast_finish: true
#  if: branch = travis-ci
#  include:
#  - name: Terminal Test
#    script:
#      - docker exec "${DOCKER_CONTAINER_NAME}" /bin/sh -c 'uname -a; lsb_release -a'
#  - name: App Test
#    before_install:
#      - docker images
#      - ifconfig
#    script:
#      - docker run --name myriota-cont -dit -v `pwd`:/CI-test myriota-travis:16.04
#      - docker exec myriota-cont /bin/sh -c './install-test.sh'
#after_script:
#  - docker exec "${DOCKER_CONTAINER_NAME}" /bin/sh -c './userdata.sh'
# Working MAtrix ends

#addons:
#  artifacts:
    # ...
#    paths:
#    - $(git ls-files -o | tr "\n" ":")
#    - $(ls /var/log/*.log | tr "\n" ":")
#    - $HOME/some/other/thing.log
#    - $(find sdk/test -name myriota_build.log | tr '\n' ':')
notifications:
  email:
    recipients:
    - vismid89@gmail.com
    on_pull_requests: false
    on_success: always
    on_failure: always
    on_start: always
    on_cancel: always
    on_error: always
